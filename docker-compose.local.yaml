# Docker Compose for running Minute entirely locally with local models
#
# This configuration uses:
# - Ollama for local LLM inference (GPU accelerated)
# - Local Whisper (faster-whisper) for speech-to-text
# - Local file storage instead of S3
# - LocalStack for message queues (SQS emulation)
#
# Usage:
#   docker compose -f docker-compose.local.yaml up --build
#
# Prerequisites:
#   1. Install Ollama: https://ollama.com/download
#   2. Pull required models:
#      ollama pull llama3.2:latest
#      ollama pull deepseek-r1:32b  (or your preferred large model)
#   3. NVIDIA GPU with CUDA support (recommended)

services:
  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    ports:
      - "8080:8080"
    env_file:
      - .env.local
    environment:
      - POSTGRES_HOST=db
      - LOCALSTACK_URL=http://localstack:4566
      - STORAGE_SERVICE_NAME=local
      - LOCAL_STORAGE_PATH=/static
      # Local LLM settings
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - FAST_LLM_PROVIDER=ollama
      - FAST_LLM_MODEL_NAME=llama3.2:latest
      - BEST_LLM_PROVIDER=ollama
      - BEST_LLM_MODEL_NAME=deepseek-r1:32b
      # Local transcription
      - TRANSCRIPTION_SERVICES=["whisper_local"]
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - type: bind
        source: ./.data
        target: /static
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8080/healthcheck"]
      interval: 60s
      retries: 3
      start_period: 30s
      timeout: 5s
    develop:
      watch:
        - path: ./backend
          target: /app/backend
          action: sync+restart
        - path: ./common
          target: /app/common
          action: sync+restart
        - path: ./pyproject.toml
          action: rebuild

  worker:
    build:
      context: .
      dockerfile: ./worker/Dockerfile
      args:
        # Install worker + local model dependencies for local mode
        INSTALL_EXTRAS: "worker,local"
    shm_size: 8gb # Increased for Whisper model
    # TODO: For GPU support, configure NVIDIA as default Docker runtime:
    # Edit /etc/docker/daemon.json to set "default-runtime": "nvidia"
    # Then add: runtime: nvidia
    env_file:
      - .env.local
    ports:
      - "8265:8265"
    volumes:
      - /tmp:/tmp
      - type: bind
        source: ./.data
        target: /static
      # Mount Whisper model cache to avoid re-downloading
      - whisper_models:/root/.cache/huggingface
    environment:
      - POSTGRES_HOST=db
      - RAY_DASHBOARD_HOST=0.0.0.0
      - LOCALSTACK_URL=http://localstack:4566
      - STORAGE_SERVICE_NAME=local
      - LOCAL_STORAGE_PATH=/static
      # Local LLM settings
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - FAST_LLM_PROVIDER=ollama
      - FAST_LLM_MODEL_NAME=llama3.2:latest
      - BEST_LLM_PROVIDER=ollama
      - BEST_LLM_MODEL_NAME=deepseek-r1:32b
      # Local Whisper settings (CPU mode - for GPU, see TODO above)
      - TRANSCRIPTION_SERVICES=["whisper_local"]
      - WHISPER_MODEL_SIZE=large-v3
      - WHISPER_DEVICE=cpu
      - WHISPER_COMPUTE_TYPE=int8
    extra_hosts:
      - "host.docker.internal:host-gateway"
    stop_grace_period: 30s # Allow time for transcription to complete
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python worker/healthcheck.py"]
      interval: 60s
      retries: 3
      start_period: 120s # Increased for model loading
      timeout: 10s
    develop:
      watch:
        - path: ./worker
          target: /app/worker
          action: sync+restart
        - path: ./common
          target: /app/common
          action: sync+restart
        - path: ./pyproject.toml
          action: rebuild

  frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile.dev
      args:
        - NEXT_PUBLIC_SENTRY_DSN=
        - NEXT_PUBLIC_POSTHOG_API_KEY=
    ports:
      - "3000:3000"
    env_file:
      - .env.local
    depends_on:
      backend:
        condition: service_started
    environment:
      - BACKEND_HOST=http://backend:8080
      - NEXT_PUBLIC_SENTRY_DSN=
      - NEXT_PUBLIC_POSTHOG_API_KEY=
    volumes:
      - next_data:/app/.next
    develop:
      watch:
        - path: ./frontend
          target: /app
          action: sync
          ignore:
            - node_modules/
            - .next/
        - path: ./frontend/package.json
          action: rebuild

  db:
    image: postgres:13
    user: postgres
    env_file:
      - .env.local
    volumes:
      - local_postgres_data:/var/lib/postgresql/data:Z
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-d", "minute_db"]
      interval: 5s
      timeout: 30s
      retries: 24
      start_period: 30s

  localstack:
    image: localstack/localstack:latest
    env_file:
      - .env.local
    ports:
      - 4566:4566
      - 4510-4559:4510-4559
    volumes:
      - ./localstack-setup.sh:/etc/localstack/init/ready.d/script.sh
    environment:
      - AWS_DEFAULT_REGION=eu-west-2
    healthcheck:
      test: ["CMD", "test", "-f", "/ready.txt"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s

volumes:
  local_postgres_data: {}
  next_data: {}
  whisper_models: {} # Persist Whisper models to avoid re-downloading
